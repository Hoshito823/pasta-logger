<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>Pasta Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="apple-touch-icon" href="/icons/pastalogger_homeicon.png">
  <link rel="icon" href="/icons/pastalogger_homeicon.png">
  <link rel="stylesheet" href="/src/style.css" />
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 bg-white/70 backdrop-blur border-b">
    <nav class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-semibold">Pasta Logger</a>
      
      <!-- スマホ用メニューボタン -->
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="btn p-2">🌓</button>
        <button id="menuToggle" class="btn p-2 md:hidden">☰</button>
      </div>
      
      <!-- デスクトップ用メニュー -->
      <div class="hidden md:flex items-center gap-3">
        <a href="/log-new.html" class="btn">新規記録</a>
        <a href="/manage.html" class="btn">管理</a>
      </div>
    </nav>
    
    <!-- スマホ用ドロップダウンメニュー -->
    <div id="mobileMenu" class="hidden bg-white border-t md:hidden">
      <div class="mx-auto max-w-3xl px-4 py-3 space-y-2">
        <a href="/log-new.html" class="block py-2 px-4 hover:bg-gray-50 rounded-lg">📝 新規記録</a>
        <a href="/manage.html" class="block py-2 px-4 hover:bg-gray-50 rounded-lg">⚙️ 管理</a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-3xl px-4 py-6 space-y-6">
    <section class="card space-y-4">
      <h1 class="text-2xl font-bold italian-accent">ようこそ</h1>
      
      <!-- スマホ用：縦並びの大きなボタン -->
      <div class="grid gap-3 sm:hidden">
        <a class="btn btn-primary py-4 text-lg" href="/log-new.html">
          <span>📝</span>
          <span>新規記録（調理タイマー付き）</span>
        </a>
        <a class="btn py-3" href="/manage.html">
          <span>⚙️</span>
          <span>データ管理</span>
        </a>
      </div>

      <!-- デスクトップ用：横並び -->
      <div class="hidden sm:flex gap-3 flex-wrap">
        <a class="btn btn-primary" href="/log-new.html">📝 新規記録（調理タイマー付き）</a>
        <a class="btn" href="/manage.html">データ管理</a>
      </div>
    </section>

    <section id="auth"></section>

    <!-- 絞り込みフィルター -->
    <section class="card space-y-4">
      <h3 class="text-lg font-semibold">絞り込み・並び替え</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="label">カテゴリ</label>
          <select id="recipeFilter" class="input"></select>
        </div>
        <div>
          <label class="label">パスタ種類</label>
          <select id="pastaKindFilter" class="input"></select>
        </div>
        <div>
          <label class="label">太さ範囲</label>
          <div class="flex gap-2 items-center">
            <input id="thicknessMin" type="number" step="0.1" min="1.0" max="3.0" placeholder="最小" class="input text-sm">
            <span class="text-gray-500">〜</span>
            <input id="thicknessMax" type="number" step="0.1" min="1.0" max="3.0" placeholder="最大" class="input text-sm">
            <span class="text-sm text-gray-500">mm</span>
          </div>
        </div>
        <div>
          <label class="label">並び順</label>
          <select id="sortOrder" class="input">
            <option value="rating">評価順</option>
            <option value="date_desc">日付順（新→古）</option>
            <option value="date_asc">日付順（古→新）</option>
          </select>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="reload" class="btn btn-primary">絞り込み</button>
        <button id="clearFilter" class="btn">クリア</button>
      </div>
    </section>

    <!-- 履歴一覧 -->
    <section class="space-y-4">
      <h2 class="text-xl font-bold">パスタ記録</h2>
      <div id="recentLogs" class="space-y-3"></div>
    </section>
  </main>

  <script type="module">
    import { initAuthUI } from './src/auth.js'
    import { supa } from './src/supa.js'
    
    const html = document.documentElement
    document.getElementById('themeToggle').onclick = () => {
      html.classList.toggle('dark')
      localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light')
    }
    if (localStorage.getItem('theme') === 'dark') html.classList.add('dark')
    
    // モバイルメニューの切り替え
    const menuToggle = document.getElementById('menuToggle')
    const mobileMenu = document.getElementById('mobileMenu')
    
    if (menuToggle && mobileMenu) {
      menuToggle.onclick = () => {
        mobileMenu.classList.toggle('hidden')
      }
      
      // メニュー外をクリックした時に閉じる
      document.addEventListener('click', (e) => {
        if (!menuToggle.contains(e.target) && !mobileMenu.contains(e.target)) {
          mobileMenu.classList.add('hidden')
        }
      })
    }

    initAuthUI('#auth')

    // レシピとパスタ種類を読み込む
    async function loadFilters() {
      const session = await supa.auth.getSession()
      if (!session?.data?.session) return

      // レシピ一覧を取得
      const { data: recipes } = await supa.from('recipes')
        .select('id,name').eq('is_active', true).order('name')
      const recipeSelect = document.querySelector('#recipeFilter')
      recipeSelect.innerHTML = '<option value="">すべて</option>'
      recipes?.forEach(r => {
        const opt = document.createElement('option')
        opt.value = r.id
        opt.textContent = r.name
        recipeSelect.appendChild(opt)
      })

      // パスタ種類一覧を取得
      const { data: pastaKinds } = await supa.from('pasta_kinds')
        .select('id,brand,thickness_mm').eq('is_active', true).order('brand').order('thickness_mm')
      const pastaSelect = document.querySelector('#pastaKindFilter')
      pastaSelect.innerHTML = '<option value="">すべて</option>'
      pastaKinds?.forEach(p => {
        const opt = document.createElement('option')
        opt.value = p.id
        opt.textContent = `${p.brand || 'ブランド不明'} (${p.thickness_mm}mm)`
        pastaSelect.appendChild(opt)
      })
    }

    // 履歴を読み込む（絞り込み機能付き）
    async function loadRecentLogs() {
      const session = await supa.auth.getSession()
      if (!session?.data?.session) return

      const recipeId = document.querySelector('#recipeFilter').value
      const pastaKindId = document.querySelector('#pastaKindFilter').value
      const thicknessMin = document.querySelector('#thicknessMin').value
      const thicknessMax = document.querySelector('#thicknessMax').value
      const sortOrder = document.querySelector('#sortOrder').value

      let query = supa.from('pasta_logs')
        .select(`
          id,taken_at,photo_url,photo_path,recipe_id,pasta_kind_id,rating_core,feedback_text,title,
          pasta_kinds!inner(id,brand,thickness_mm),
          recipes(id,name)
        `)
        .limit(50)

      // ソート順の適用
      if (sortOrder === 'rating') {
        query = query
          .order('rating_core->>overall', { ascending: false })
          .order('taken_at', { ascending: false })
      } else if (sortOrder === 'date_desc') {
        query = query.order('taken_at', { ascending: false })
      } else if (sortOrder === 'date_asc') {
        query = query.order('taken_at', { ascending: true })
      }

      // フィルター適用
      if (recipeId) query = query.eq('recipe_id', recipeId)
      if (pastaKindId) query = query.eq('pasta_kind_id', pastaKindId)
      if (thicknessMin) query = query.gte('pasta_kinds.thickness_mm', parseFloat(thicknessMin))
      if (thicknessMax) query = query.lte('pasta_kinds.thickness_mm', parseFloat(thicknessMax))

      const { data, error } = await query

      if (error) {
        console.error('履歴の読み込みエラー:', error)
        return
      }

      const container = document.querySelector('#recentLogs')
      if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">まだ記録がありません</p>'
        return
      }

      container.innerHTML = ''
      for (const row of data) {
        const star = row.rating_core?.overall ?? '-'
        let photoUrl = row.photo_url
        if (!photoUrl && row.photo_path) {
          const { data: urlData, error: urlError } = await supa.storage
            .from('pasta-photos')
            .createSignedUrl(row.photo_path, 3600)
          if (!urlError) photoUrl = urlData.signedUrl
        }

        const img = photoUrl ? `<img src="${photoUrl}" class="w-24 h-20 object-cover rounded-lg border" />` : ''
        const title = row.title || row.recipes?.name || '料理名未登録'
        const recipeName = row.recipes?.name || '料理名未登録'
        const pastaInfo = row.pasta_kinds ? `${row.pasta_kinds.brand || 'ブランド不明'} (${row.pasta_kinds.thickness_mm}mm)` : ''

        const card = document.createElement('div')
        card.className = 'card p-0'
        card.innerHTML = `
          <a class="block p-4 hover:bg-gray-50 rounded-2xl" href="/log-detail.html?id=${row.id}">
            <div class="flex gap-3">
              ${img}
              <div class="flex-1 min-w-0">
                <div class="text-sm text-gray-500">${new Date(row.taken_at).toLocaleString()}</div>
                <div class="text-lg font-bold text-gray-900 mb-1 truncate">${title}</div>
                ${recipeName !== title ? `<div class="text-sm text-gray-500 mb-1">${recipeName}</div>` : ''}
                ${pastaInfo ? `<div class="text-sm text-gray-600 mb-1">${pastaInfo}</div>` : ''}
                <div class="text-sm text-amber-600 mb-1">★${star}</div>
                <div class="text-gray-700 text-sm line-clamp-2">${(row.feedback_text||'').slice(0,100)}</div>
              </div>
            </div>
          </a>`
        container.appendChild(card)
      }
    }

    // フィルタークリア機能
    function clearFilters() {
      document.querySelector('#recipeFilter').value = ''
      document.querySelector('#pastaKindFilter').value = ''
      document.querySelector('#thicknessMin').value = ''
      document.querySelector('#thicknessMax').value = ''
      document.querySelector('#sortOrder').value = 'rating'
      loadRecentLogs()
    }

    // ボタンイベント設定
    document.querySelector('#reload').onclick = loadRecentLogs
    document.querySelector('#clearFilter').onclick = clearFilters

    // 認証後にフィルターと履歴を読み込む
    supa.auth.onAuthStateChange((event, session) => {
      if (session) {
        loadFilters()
        loadRecentLogs()
      }
    })

    // 初回読み込み
    loadFilters()
    loadRecentLogs()
  </script>
</body>
</html>
