<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>Pasta Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="apple-touch-icon" href="/icons/pastalogger_homeicon.png">
  <link rel="icon" href="/icons/pastalogger_homeicon.png">
  <link rel="stylesheet" href="/src/style.css" />
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 bg-white/70 backdrop-blur border-b">
    <nav class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-semibold">Pasta Logger</a>
      
      <!-- ã‚¹ãƒãƒ›ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="btn p-2">ğŸŒ“</button>
        <button id="menuToggle" class="btn p-2 md:hidden">â˜°</button>
      </div>
      
      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <div class="hidden md:flex items-center gap-3">
        <a href="/log-new.html" class="btn">æ–°è¦è¨˜éŒ²</a>
        <a href="/manage.html" class="btn">ç®¡ç†</a>
      </div>
    </nav>
    
    <!-- ã‚¹ãƒãƒ›ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="mobileMenu" class="hidden bg-white border-t md:hidden">
      <div class="mx-auto max-w-3xl px-4 py-3 space-y-2">
        <a href="/log-new.html" class="block py-2 px-4 hover:bg-gray-50 rounded-lg">ğŸ“ æ–°è¦è¨˜éŒ²</a>
        <a href="/manage.html" class="block py-2 px-4 hover:bg-gray-50 rounded-lg">âš™ï¸ ç®¡ç†</a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-3xl px-4 py-6 space-y-6">
    <section class="card space-y-4">
      <h1 class="text-2xl font-bold italian-accent">ã‚ˆã†ã“ã</h1>
      
      <!-- ã‚¹ãƒãƒ›ç”¨ï¼šç¸¦ä¸¦ã³ã®å¤§ããªãƒœã‚¿ãƒ³ -->
      <div class="grid gap-3 sm:hidden">
        <a class="btn btn-primary py-4 text-lg" href="/log-new.html">
          <span>ğŸ“</span>
          <span>æ–°è¦è¨˜éŒ²ï¼ˆèª¿ç†ã‚¿ã‚¤ãƒãƒ¼ä»˜ãï¼‰</span>
        </a>
        <a class="btn py-3" href="/manage.html">
          <span>âš™ï¸</span>
          <span>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span>
        </a>
      </div>

      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼šæ¨ªä¸¦ã³ -->
      <div class="hidden sm:flex gap-3 flex-wrap">
        <a class="btn btn-primary" href="/log-new.html">ğŸ“ æ–°è¦è¨˜éŒ²ï¼ˆèª¿ç†ã‚¿ã‚¤ãƒãƒ¼ä»˜ãï¼‰</a>
        <a class="btn" href="/manage.html">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</a>
      </div>
    </section>

    <section id="auth"></section>

    <!-- çµã‚Šè¾¼ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <section class="card space-y-4">
      <h3 class="text-lg font-semibold">çµã‚Šè¾¼ã¿ãƒ»ä¸¦ã³æ›¿ãˆ</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="label">ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="recipeFilter" class="input"></select>
        </div>
        <div>
          <label class="label">ãƒ‘ã‚¹ã‚¿ç¨®é¡</label>
          <select id="pastaKindFilter" class="input"></select>
        </div>
        <div>
          <label class="label">å¤ªã•ç¯„å›²</label>
          <div class="flex gap-2 items-center">
            <input id="thicknessMin" type="number" step="0.1" min="1.0" max="3.0" placeholder="æœ€å°" class="input text-sm">
            <span class="text-gray-500">ã€œ</span>
            <input id="thicknessMax" type="number" step="0.1" min="1.0" max="3.0" placeholder="æœ€å¤§" class="input text-sm">
            <span class="text-sm text-gray-500">mm</span>
          </div>
        </div>
        <div>
          <label class="label">ä¸¦ã³é †</label>
          <select id="sortOrder" class="input">
            <option value="rating">è©•ä¾¡é †</option>
            <option value="date_desc">æ—¥ä»˜é †ï¼ˆæ–°â†’å¤ï¼‰</option>
            <option value="date_asc">æ—¥ä»˜é †ï¼ˆå¤â†’æ–°ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="reload" class="btn btn-primary">çµã‚Šè¾¼ã¿</button>
        <button id="clearFilter" class="btn">ã‚¯ãƒªã‚¢</button>
      </div>
    </section>

    <!-- å±¥æ­´ä¸€è¦§ -->
    <section class="space-y-4">
      <h2 class="text-xl font-bold">ãƒ‘ã‚¹ã‚¿è¨˜éŒ²</h2>
      <div id="recentLogs" class="space-y-3"></div>
    </section>
  </main>

  <script type="module">
    import { initAuthUI } from './src/auth.js'
    import { supa } from './src/supa.js'
    
    const html = document.documentElement
    document.getElementById('themeToggle').onclick = () => {
      html.classList.toggle('dark')
      localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light')
    }
    if (localStorage.getItem('theme') === 'dark') html.classList.add('dark')
    
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
    const menuToggle = document.getElementById('menuToggle')
    const mobileMenu = document.getElementById('mobileMenu')
    
    if (menuToggle && mobileMenu) {
      menuToggle.onclick = () => {
        mobileMenu.classList.toggle('hidden')
      }
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«é–‰ã˜ã‚‹
      document.addEventListener('click', (e) => {
        if (!menuToggle.contains(e.target) && !mobileMenu.contains(e.target)) {
          mobileMenu.classList.add('hidden')
        }
      })
    }

    initAuthUI('#auth')

    // ãƒ¬ã‚·ãƒ”ã¨ãƒ‘ã‚¹ã‚¿ç¨®é¡ã‚’èª­ã¿è¾¼ã‚€
    async function loadFilters() {
      const session = await supa.auth.getSession()
      if (!session?.data?.session) return

      // ãƒ¬ã‚·ãƒ”ä¸€è¦§ã‚’å–å¾—
      const { data: recipes } = await supa.from('recipes')
        .select('id,name').eq('is_active', true).order('name')
      const recipeSelect = document.querySelector('#recipeFilter')
      recipeSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>'
      recipes?.forEach(r => {
        const opt = document.createElement('option')
        opt.value = r.id
        opt.textContent = r.name
        recipeSelect.appendChild(opt)
      })

      // ãƒ‘ã‚¹ã‚¿ç¨®é¡ä¸€è¦§ã‚’å–å¾—
      const { data: pastaKinds } = await supa.from('pasta_kinds')
        .select('id,brand,thickness_mm').eq('is_active', true).order('brand').order('thickness_mm')
      const pastaSelect = document.querySelector('#pastaKindFilter')
      pastaSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>'
      pastaKinds?.forEach(p => {
        const opt = document.createElement('option')
        opt.value = p.id
        opt.textContent = `${p.brand || 'ãƒ–ãƒ©ãƒ³ãƒ‰ä¸æ˜'} (${p.thickness_mm}mm)`
        pastaSelect.appendChild(opt)
      })
    }

    // å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€ï¼ˆçµã‚Šè¾¼ã¿æ©Ÿèƒ½ä»˜ãï¼‰
    async function loadRecentLogs() {
      const session = await supa.auth.getSession()
      if (!session?.data?.session) return

      const recipeId = document.querySelector('#recipeFilter').value
      const pastaKindId = document.querySelector('#pastaKindFilter').value
      const thicknessMin = document.querySelector('#thicknessMin').value
      const thicknessMax = document.querySelector('#thicknessMax').value
      const sortOrder = document.querySelector('#sortOrder').value

      let query = supa.from('pasta_logs')
        .select(`
          id,taken_at,photo_url,photo_path,recipe_id,pasta_kind_id,rating_core,feedback_text,title,
          pasta_kinds!inner(id,brand,thickness_mm),
          recipes(id,name)
        `)
        .limit(50)

      // ã‚½ãƒ¼ãƒˆé †ã®é©ç”¨
      if (sortOrder === 'rating') {
        query = query
          .order('rating_core->>overall', { ascending: false })
          .order('taken_at', { ascending: false })
      } else if (sortOrder === 'date_desc') {
        query = query.order('taken_at', { ascending: false })
      } else if (sortOrder === 'date_asc') {
        query = query.order('taken_at', { ascending: true })
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
      if (recipeId) query = query.eq('recipe_id', recipeId)
      if (pastaKindId) query = query.eq('pasta_kind_id', pastaKindId)
      if (thicknessMin) query = query.gte('pasta_kinds.thickness_mm', parseFloat(thicknessMin))
      if (thicknessMax) query = query.lte('pasta_kinds.thickness_mm', parseFloat(thicknessMax))

      const { data, error } = await query

      if (error) {
        console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error)
        return
      }

      const container = document.querySelector('#recentLogs')
      if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>'
        return
      }

      container.innerHTML = ''
      for (const row of data) {
        const star = row.rating_core?.overall ?? '-'
        let photoUrl = row.photo_url
        if (!photoUrl && row.photo_path) {
          const { data: urlData, error: urlError } = await supa.storage
            .from('pasta-photos')
            .createSignedUrl(row.photo_path, 3600)
          if (!urlError) photoUrl = urlData.signedUrl
        }

        const img = photoUrl ? `<img src="${photoUrl}" class="w-24 h-20 object-cover rounded-lg border" />` : ''
        const title = row.title || row.recipes?.name || 'æ–™ç†åæœªç™»éŒ²'
        const recipeName = row.recipes?.name || 'æ–™ç†åæœªç™»éŒ²'
        const pastaInfo = row.pasta_kinds ? `${row.pasta_kinds.brand || 'ãƒ–ãƒ©ãƒ³ãƒ‰ä¸æ˜'} (${row.pasta_kinds.thickness_mm}mm)` : ''

        const card = document.createElement('div')
        card.className = 'card p-0'
        card.innerHTML = `
          <a class="block p-4 hover:bg-gray-50 rounded-2xl" href="/log-detail.html?id=${row.id}">
            <div class="flex gap-3">
              ${img}
              <div class="flex-1 min-w-0">
                <div class="text-sm text-gray-500">${new Date(row.taken_at).toLocaleString()}</div>
                <div class="text-lg font-bold text-gray-900 mb-1 truncate">${title}</div>
                ${recipeName !== title ? `<div class="text-sm text-gray-500 mb-1">${recipeName}</div>` : ''}
                ${pastaInfo ? `<div class="text-sm text-gray-600 mb-1">${pastaInfo}</div>` : ''}
                <div class="text-sm text-amber-600 mb-1">â˜…${star}</div>
                <div class="text-gray-700 text-sm line-clamp-2">${(row.feedback_text||'').slice(0,100)}</div>
              </div>
            </div>
          </a>`
        container.appendChild(card)
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢æ©Ÿèƒ½
    function clearFilters() {
      document.querySelector('#recipeFilter').value = ''
      document.querySelector('#pastaKindFilter').value = ''
      document.querySelector('#thicknessMin').value = ''
      document.querySelector('#thicknessMax').value = ''
      document.querySelector('#sortOrder').value = 'rating'
      loadRecentLogs()
    }

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.querySelector('#reload').onclick = loadRecentLogs
    document.querySelector('#clearFilter').onclick = clearFilters

    // èªè¨¼å¾Œã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
    supa.auth.onAuthStateChange((event, session) => {
      if (session) {
        loadFilters()
        loadRecentLogs()
      }
    })

    // åˆå›èª­ã¿è¾¼ã¿
    loadFilters()
    loadRecentLogs()
  </script>
</body>
</html>
